<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>EAN Scanner ‚Äî Handheld + CSV DB</title>
<style>
  :root { --brand:#2563eb; --ok:#16a34a; --bad:#dc2626; --bg:#0b1020; --card:#0f172a; --muted:#94a3b8; }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;background:var(--bg);color:#e5e7eb}
  .wrap{max-width:780px;margin:0 auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .hgroup h1{font-size:20px;font-weight:800;color:#fff}
  .hgroup p{font-size:12px;color:#fff;opacity:.75}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#0b1226;border:1px solid #1f2a44;color:#cbd5e1;padding:8px 10px;border-radius:999px;font-size:12px}
  .dot{width:8px;height:8px;border-radius:50%;background:#64748b}
  .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)}
  .card{background:var(--card);border:1px solid #1f2840;border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);margin-bottom:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input.scan{flex:1;padding:14px;border:2px solid #233055;background:#0b1226;color:#e5e7eb;border-radius:12px;font-size:20px;letter-spacing:2px;outline:none}
  input.scan:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.25)}
  button{appearance:none;border:0;background:var(--brand);color:#fff;padding:12px 14px;border-radius:12px;font-weight:800;font-size:16px;cursor:pointer}
  button.danger{background:var(--bad)}
  .file{position:relative;overflow:hidden}
  .file input{position:absolute;inset:0;opacity:0;cursor:pointer}
  .muted{color:var(--muted);font-size:12px}
  .warn{display:none;margin-bottom:12px;background:#3a0a0a;border:1px solid #7f1d1d;color:#fecaca;padding:10px 12px;border-radius:12px}
  .oknote{display:none;margin-bottom:12px;background:#05280f;border:1px solid #14532d;color:#c7f9cc;padding:10px 12px;border-radius:12px}
  .result{position:fixed;left:50%;top:10px;transform:translateX(-50%);z-index:50;
          display:none;opacity:0;transition:opacity .18s;text-align:center;
          border-radius:14px;padding:18px 22px;border:2px solid var(--ok);background:#05280ff0}
  .result.show{display:block;opacity:1}
  .result.error{border-color:var(--bad);background:#3a0a0af0}
  .result .label{font-size:16px;color:#cbd5e1}
  .result .value{font-size:56px;font-weight:900;letter-spacing:1px;color:#a5b4fc}
  .result.error .value{color:#fecaca;font-size:44px}
  .kbd{background:#0b1226;padding:2px 6px;border-radius:6px;border:1px solid #223058;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div id="dbWarn" class="warn">‚ö†Ô∏è No data loaded. Click ‚ÄúLoad CSV‚Äù. CSV must have headers; Column A = EAN, Column B = Location.</div>
    <div id="dbOk" class="oknote">‚úÖ Database loaded: <b><span id="dbCountTop">0</span></b> rows.</div>

    <header>
      <div class="hgroup">
        <h1>üì¶ EAN Scanner ‚Äî Handheld + CSV DB</h1>
        <p>Load your CSV (first row headers). Column A = EAN, Column B = Location.</p>
      </div>
      <div id="status" class="pill"><span id="dot" class="dot"></span><span id="statText">Waiting for CSV‚Ä¶</span></div>
    </header>

    <div class="card">
      <div class="row">
        <label class="file">
          <button id="loadBtn">üìÇ Load CSV</button>
          <input id="fileInput" type="file" accept=".csv,text/csv"/>
        </label>
        <button id="resetBtn" class="danger">‚ôªÔ∏è Hard Reset</button>
        <span class="muted" id="dbMeta">No file loaded</span>
      </div>
      <div class="muted" style="margin-top:6px;">
        ‚Ä¢ Digits only ‚Ä¢ End-of-scan on <span class="kbd">Enter</span> or short pause ‚Ä¢ UPC-A (12 digits) auto-normalized to EAN-13 (leading <span class="kbd">0</span>) ‚Ä¢ EAN-13/EAN-8 checksum validation
      </div>
    </div>

    <div class="card">
      <div class="row">
        <input id="sink" class="scan" type="text" inputmode="none" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Load CSV, then focus here & scan‚Ä¶" disabled />
      </div>
      <div class="muted" style="margin-top:6px;">Rows loaded: <span id="dbCount">0</span></div>
    </div>
  </div>

  <div id="out" class="result">
    <div class="label">Location</div>
    <div id="outValue" class="value"></div>
    <div id="outEan" class="muted"></div>
  </div>

<script>
const fileInput=document.getElementById('fileInput');
const loadBtn=document.getElementById('loadBtn');
const sink=document.getElementById('sink');
const resetBtn=document.getElementById('resetBtn');
const out=document.getElementById('out');
const outValue=document.getElementById('outValue');
const outEan=document.getElementById('outEan');
const statText=document.getElementById('statText');
const dot=document.getElementById('dot');
const dbMeta=document.getElementById('dbMeta');
const dbCount=document.getElementById('dbCount');
const dbCountTop=document.getElementById('dbCountTop');
const dbWarn=document.getElementById('dbWarn');
const dbOk=document.getElementById('dbOk');
const setStatus=(t,ok=null)=>{statText.textContent=t;dot.className='dot'+(ok===true?' ok':ok===false?' bad':'');};
const digitsOnly=s=>String(s||'').replace(/\D+/g,'');
let eanDB={};

function detectDelimiter(line){return(line.match(/;/g)||[]).length>(line.match(/,/g)||[]).length?';':',';}
function parseCSV(text){
  if(text.charCodeAt(0)===0xFEFF)text=text.slice(1);
  const firstNL=text.indexOf('\n');const head=firstNL===-1?text:text.slice(0,firstNL);
  const delim=detectDelimiter(head);const rows=[];let i=0,f='',r=[],q=false;
  for(;i<text.length;i++){const c=text[i];
    if(q){if(c==='"'){if(text[i+1]==='"'){f+='"';i++;}else q=false;}else f+=c;}
    else{if(c==='"')q=true;else if(c===delim){r.push(f);f='';}
    else if(c==='\n'||c==='\r'){if(c==='\r'&&text[i+1]==='\n')i++;r.push(f);f='';if(r.length>1||(r.length===1&&r[0]!==''))rows.push(r);r=[];}
    else f+=c;}}
  if(f.length>0||q||r.length>0){r.push(f);rows.push(r);}return rows;
}
const checksumEAN13=c=>{if(c.length!==13)return!1;let s=0;for(let i=0;i<12;i++){const n=c.charCodeAt(i)-48;s+=(i%2===0)?n:3*n;}return(10-(s%10))%10===c.charCodeAt(12)-48;};
const checksumEAN8=c=>{if(c.length!==8)return!1;const w=[3,1,3,1,3,1,3];let s=0;for(let i=0;i<7;i++)s+=(c.charCodeAt(i)-48)*w[i];return(10-(s%10))%10===c.charCodeAt(7)-48;};
const normalizeCode=r=>{let d=digitsOnly(r);if(!d)return'';if(d.length===12)d='0'+d;return d;};
function buildDBFromCSV(text){
  const rows=parseCSV(text);if(!rows.length)return 0;const map={};
  for(const row of rows.slice(1)){if(!row.length)continue;const e=normalizeCode(row[0]);if(!e)continue;map[e]=String(row[1]||'').trim();}
  eanDB=map;const n=Object.keys(eanDB).length;
  dbCount.textContent=n;dbCountTop.textContent=n;dbMeta.textContent=n?`Loaded ${n} rows`:'No file loaded';
  dbWarn.style.display=n?'none':'block';dbOk.style.display=n?'block':'none';sink.disabled=!n;if(n){sink.focus();setStatus('Ready',true);}return n;
}
function beep(ok=true){try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.type='sine';o.frequency.value=ok?880:220;o.connect(g);g.connect(ctx.destination);g.gain.setValueAtTime(ok?0.25:0.2,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.12);o.start();o.stop(ctx.currentTime+0.12);}catch(e){}}
function showResult(txt,ean,err=false){out.className='result show'+(err?' error':'');outValue.textContent=txt;outEan.textContent='EAN: '+ean;beep(!err);setTimeout(()=>out.classList.remove('show'),2000);}
let buf='',keyTimer=null,inputTimer=null;const KEY_IDLE=350,INPUT_IDLE=120;
function finalizeScan(){const raw=buf||sink.value;buf='';let code=normalizeCode(raw);if(!code)return clearNext();let ok=false;if(code.length===13)ok=checksumEAN13(code);else if(code.length===8)ok=checksumEAN8(code);
if(!ok){showResult('Invalid barcode',code||raw,true);return clearNext(true);}if(eanDB.hasOwnProperty(code))showResult(eanDB[code],code,false);else showResult('EAN not found',code,true);clearNext();}
function clearNext(err=false){sink.value='';setTimeout(()=>sink.focus(),0);setStatus(err?'Error':'Ready',!err);}
sink.addEventListener('keydown',e=>{const d=/^[0-9]$/.test(e.key),en=e.key==='Enter',bk=e.key==='Backspace';if(!d&&!en&&!bk){e.preventDefault();return;}if(en){e.preventDefault();finalizeScan();return;}
if(d){setStatus('Scanning‚Ä¶');buf+=e.key;if(keyTimer)clearTimeout(keyTimer);keyTimer=setTimeout(finalizeScan,KEY_IDLE);}else if(bk)buf=buf.slice(0,-1);});
sink.addEventListener('input',()=>{const c=digitsOnly(sink.value);if(sink.value!==c)sink.value=c;if(c.length>=8){if(inputTimer)clearTimeout(inputTimer);inputTimer=setTimeout(finalizeScan,INPUT_IDLE);}});
setInterval(()=>{if(document.activeElement!==sink&&!sink.disabled)sink.focus();},1500);
resetBtn.addEventListener('click',()=>{setStatus('Resetting‚Ä¶');buf='';sink.value='';out.classList.remove('show');setTimeout(()=>{sink.focus();setStatus('Ready',true);},150);});
loadBtn.addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change',async e=>{const f=e.target.files&&e.target.files[0];if(!f)return;const t=await f.text();const n=buildDBFromCSV(t);if(!n)setStatus('CSV problem',false);});
setStatus('Waiting for CSV‚Ä¶');dbWarn.style.display='block';
</script>
</body>
</html>
